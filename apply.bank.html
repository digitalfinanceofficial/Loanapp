<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Apply — Bank Details | SmartCash Finance</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --ink:#0A2F33; --brand:#1f5d63; --ok:#10b981; --muted:#e5e7eb; }
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .nav-link{padding:.5rem 1rem;border-radius:9999px}
    .nav-active{background:#0A2F33;color:#fff !important}
    .card{border-radius:1.25rem;box-shadow:0 12px 32px rgba(0,0,0,.08)}
    .err{display:none}.has-error .err{display:block}
    .teal-dots{
      background:
        radial-gradient(circle at 12px 12px, rgba(255,255,255,.07) 2px, transparent 2.6px) 0 0/24px 24px,
        #1f5d63;
    }
    .step-dot{width:12px;height:12px;border-radius:9999px;background:#d1d5db}
    .step-dot.done{background:var(--ok)}
    .step-dot.active{background:#f59e0b}
    .linkbar{height:6px;border-radius:9999px;background:var(--muted);overflow:hidden;position:relative}
    .linkfill{height:100%;width:0;background:var(--ok);transition:width .25s ease}
    .label{font-size:12px}
    .lock-note{background:#fff3cd;border:1px solid #ffe69c;color:#664d03}
    .uploader{border:1px dashed #cbd5e1;border-radius:0.75rem;padding:0.75rem;background:#f8fafc}
    .thumb{width:90px;height:90px;object-fit:cover;border-radius:0.5rem;border:1px solid #e5e7eb;background:#fff}
    .note{font-size:12px;color:#6b7280}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">

<header class="border-b bg-white sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
    <a href="index.html" class="flex items-center gap-3">
      <img src="assets/logo.png" class="w-12 h-12 rounded-lg" alt="SmartCash"/>
      <div>
        <div class="text-xl font-extrabold text-blue-700 leading-tight">SmartCash</div>
        <div class="text-[11px] tracking-widest text-blue-600 uppercase">Finance</div>
      </div>
    </a>
    <nav class="hidden md:flex items-center gap-2 text-sm">
      <a href="index.html" class="nav-link">Home</a>
      <a href="loan-products.html" class="nav-link">Products</a>
      <a href="about.html" class="nav-link">About Us</a>
      <a href="contact.html" class="nav-link">Contact</a>
      <a href="calculator.html" class="nav-link">EMI Calculator</a>
      <a href="status.html" class="nav-link">Status Check</a>
    </nav>
    <button id="menuBtn" class="md:hidden p-2 rounded-lg border" aria-label="Open menu">
      <svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 7h16M4 12h16M4 17h16" stroke="#111827" stroke-width="2" stroke-linecap="round"/></svg>
    </button>
  </div>
  <div id="mobileMenu" class="hidden md:hidden border-t bg-white">
    <div class="max-w-7xl mx-auto px-4 py-3 grid gap-2 text-sm">
      <a class="py-2 border-b" href="index.html">Home</a>
      <a class="py-2 border-b" href="loan-products.html">Products</a>
      <a class="py-2 border-b" href="about.html">About Us</a>
      <a class="py-2 border-b" href="status.html">Status Check</a>
      <a class="py-2" href="calculator.html">EMI Calculator</a>
    </div>
  </div>
</header>

<section class="teal-dots text-white">
  <div class="max-w-7xl mx-auto px-6 py-8">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h1 class="text-3xl md:text-4xl font-extrabold">Bank Details</h1>
        <p class="text-white/90 mt-2">Enter your bank details to receive the disbursal offer.</p>
      </div>
      <div id="appIdPill" class="hidden bg-white/15 border border-white/35 text-xs md:text-sm px-3 py-1.5 rounded-full">
        App ID: <span id="appIdText" class="font-semibold ml-1"></span>
      </div>
    </div>

    <!-- Stepper -->
    <div class="mt-6 bg-white/10 rounded-2xl px-4 py-3">
      <div class="flex items-center gap-2">
        <span class="step-dot done"></span>
        <div class="flex-1 linkbar"><div class="linkfill" style="width:100%"></div></div>
        <span class="step-dot done"></span>
        <div class="flex-1 linkbar"><div class="linkfill" style="width:100%"></div></div>
        <span class="step-dot done"></span>
        <div class="flex-1 linkbar"><div class="linkfill" style="width:100%"></div></div>
        <span class="step-dot active"></span>
        <div class="flex-1 linkbar" id="barBank"></div>
        <span class="step-dot"></span>
        <div class="flex-1 linkbar"></div>
        <span class="step-dot"></span>
      </div>
      <div class="grid grid-cols-6 mt-2 text-center label text-white/90">
        <div>Personal</div><div>Work</div><div>KYC</div><div>Bank</div><div>Offer</div><div>Disbursed</div>
      </div>
    </div>
  </div>
</section>

<main class="max-w-4xl mx-auto px-6 -mt-8 pb-16">
  <div id="lockNote" class="hidden lock-note rounded-xl px-4 py-3 mb-3 text-sm">
    Bank details submitted. Changes are locked. Please proceed to Offer.
  </div>

  <form id="bform" class="bg-white card ring-1 ring-black/5 p-6 space-y-7" novalidate>
    <h2 class="text-2xl font-extrabold">Bank Account Details</h2>

    <div class="grid md:grid-cols-2 gap-4">
      <div id="gHolder">
        <label class="text-sm font-medium">Account Holder Name</label>
        <input id="holder" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="As per bank records" required>
        <p class="note mt-1">Auto-fetched from your Personal details. You can edit if needed.</p>
        <p class="err text-xs text-red-600 mt-1">Enter account holder name (min 3 chars).</p>
      </div>
      <div id="gIFSC">
        <label class="text-sm font-medium">IFSC</label>
        <input id="ifsc" class="mt-1 w-full border rounded-lg px-3 py-2 uppercase" placeholder="e.g., HDFC0001234" maxlength="11" required>
        <p class="err text-xs text-red-600 mt-1">Enter a valid 11-char IFSC.</p>
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-4">
      <div id="gAcc1">
        <label class="text-sm font-medium">Account Number</label>
        <input id="acc1" inputmode="numeric" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="e.g., 12345678901" required>
        <p class="err text-xs text-red-600 mt-1">Enter a valid account number.</p>
      </div>
      <div id="gAcc2">
        <label class="text-sm font-medium">Confirm Account Number</label>
        <input id="acc2" inputmode="numeric" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="Re-enter account number" required>
        <p class="err text-xs text-red-600 mt-1">Account numbers do not match.</p>
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <label class="text-sm font-medium">Bank</label>
        <input id="bankName" class="mt-1 w-full border rounded-lg px-3 py-2 bg-gray-50" placeholder="Auto-filled" readonly>
      </div>
      <div>
        <label class="text-sm font-medium">Branch (Full Address)</label>
        <input id="branch" class="mt-1 w-full border rounded-lg px-3 py-2 bg-gray-50" placeholder="Auto-filled" readonly>
      </div>
    </div>

    <div id="gCheque" class="uploader">
      <label class="text-sm font-semibold">Cancelled Cheque / Passbook Photo</label>
      <div class="mt-2 flex items-center gap-3">
        <img id="preCheque" class="thumb hidden" alt="Preview"/>
        <input id="fileCheque" type="file" accept="image/*" capture="environment" class="block w-full text-sm" required>
      </div>
      <p class="text-[12px] text-gray-500 mt-1">Use rear camera or gallery. JPG/PNG.</p>
      <p class="err text-xs text-red-600 mt-1">Please upload cheque/passbook photo.</p>
    </div>

    <!-- OPTIONAL: 3-month bank statement -->
    <div id="gStmt" class="uploader">
      <label class="text-sm font-semibold">Last 3 Months Bank Statement (Optional)</label>
      <div class="mt-2 grid md:grid-cols-[1fr_auto] gap-3 items-center">
        <div class="flex items-center gap-3">
          <span id="stmtFileName" class="text-sm text-gray-700 hidden"></span>
          <input id="fileStmt" type="file" accept="application/pdf" class="block w-full text-sm">
        </div>
        <span class="text-xs text-gray-500">PDF only</span>
      </div>
      <div id="stmtPwWrap" class="mt-3 hidden">
        <label class="text-sm font-medium">PDF Password (Optional)</label>
        <input id="stmtPw" type="password" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="Enter PDF password if protected">
        <p class="note mt-1">Only if your PDF is password protected.</p>
      </div>
    </div>

    <div class="flex items-center justify-between pt-2">
      <a id="backBtn" href="#" class="inline-flex items-center gap-2 px-5 py-3 rounded-full border font-semibold">← Back</a>
      <button id="nextBtn" disabled class="px-8 py-3 rounded-full font-semibold text-white bg-gray-300 cursor-not-allowed transition">Continue to Offer</button>
    </div>
  </form>
</main>

<footer class="border-t bg-white">
  <div class="max-w-7xl mx-auto px-6 py-6 text-center text-[13px] text-gray-600">
    © <span id="yr"></span> SmartCash Finance • <a class="underline" href="privacy.html">Privacy</a> • <a class="underline" href="terms.html">Terms</a>
  </div>
</footer>

<script>
const APP_KEY='scf_app', DRAFT_KEY='scf_apply_bank', PERSONAL_KEY='scf_apply_personal';
document.getElementById('yr').textContent=new Date().getFullYear();
document.getElementById('menuBtn')?.addEventListener('click',()=>document.getElementById('mobileMenu').classList.toggle('hidden'));

// Helpers
const titleCase=s=>String(s||'').toLowerCase().split(/\s+/).filter(Boolean).map(w=>w[0].toUpperCase()+w.slice(1)).join(' ');
const isIFSC=v=>/^[A-Z]{4}0[A-Z0-9]{6}$/.test(String(v||'').trim().toUpperCase());
const isAcc=v=>/^\d{9,18}$/.test(String(v||'').trim()); // common range
function get(k){ try{return JSON.parse(localStorage.getItem(k)||'null')}catch{return null} }
function set(k,v){ localStorage.setItem(k, JSON.stringify(v||{})) }
function getApp(){ return get(APP_KEY) || {} }
function setApp(o){ set(APP_KEY, o||{}) }
function routeToStage(stage){
  const s=String(stage||'').toLowerCase();
  if(s==='personal')return 'apply.html';
  if(s==='work')return 'apply.work.html';
  if(s==='kyc')return 'apply.kyc.html';
  if(s==='bank')return 'apply.bank.html';
  if(s==='offer')return 'offer.html';
  if(s==='disbursed')return 'disbursed.html';
  return 'apply.html';
}
function showAppId(id){ if(id){ document.getElementById('appIdText').textContent=id; document.getElementById('appIdPill').classList.remove('hidden'); } }
function setLocked(locked){
  document.querySelectorAll('#bform input').forEach(el=>{
    if(el.type==='file'){ el.disabled=locked; } else { el.readOnly=locked; }
    el.classList.toggle('bg-gray-50',locked);
  });
  document.getElementById('nextBtn').style.display=locked?'none':'';
  document.getElementById('lockNote').classList.toggle('hidden',!locked);
}
function setErr(id,bad){ document.getElementById(id).classList.toggle('has-error',bad); }

// Elements
const holder=document.getElementById('holder');
const ifsc=document.getElementById('ifsc');
const acc1=document.getElementById('acc1');
const acc2=document.getElementById('acc2');
const bankName=document.getElementById('bankName');
const branch=document.getElementById('branch');
const fileCheque=document.getElementById('fileCheque');
const preCheque=document.getElementById('preCheque');
const fileStmt=document.getElementById('fileStmt');
const stmtFileName=document.getElementById('stmtFileName');
const stmtPwWrap=document.getElementById('stmtPwWrap');
const stmtPw=document.getElementById('stmtPw');
const nextBtn=document.getElementById('nextBtn');

// Prefill: Account Holder from Personal/app
(function prefillHolder(){
  const app=getApp();
  const personal = get(PERSONAL_KEY) || {};
  const name = app?.name || personal?.name || '';
  if(name && !holder.value){ holder.value = titleCase(name); }
})();

// Behaviors
ifsc.addEventListener('input', ()=>{
  ifsc.value = ifsc.value.toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,11);
  bankName.value=''; branch.value='';
});
acc1.addEventListener('input', ()=>{ acc1.value = acc1.value.replace(/\D/g,''); });
acc2.addEventListener('input', ()=>{ acc2.value = acc2.value.replace(/\D/g,''); });

// IFSC → bank + FULL ADDRESS
let ifscTimer=null;
ifsc.addEventListener('blur', fetchIFSC);
ifsc.addEventListener('input', ()=>{
  if(ifscTimer) clearTimeout(ifscTimer);
  ifscTimer=setTimeout(()=>{ if(isIFSC(ifsc.value)) fetchIFSC(); }, 500);
});
async function fetchIFSC(){
  const code=ifsc.value.trim().toUpperCase();
  if(!isIFSC(code)) return;
  try{
    const res = await fetch('https://ifsc.razorpay.com/'+code);
    if(!res.ok) throw 0;
    const data = await res.json(); // {BANK, BRANCH, ADDRESS, CITY, STATE, ...}
    bankName.value = data?.BANK || '';
    // Branch field = FULL ADDRESS (prefer ADDRESS + ", " + CITY + ", " + STATE)
    const parts = [];
    if(data?.ADDRESS) parts.push(data.ADDRESS);
    if(data?.CITY) parts.push(data.CITY);
    if(data?.STATE) parts.push(data.STATE);
    branch.value = parts.join(', ');
  }catch{
    bankName.value=''; branch.value='';
  }
  validate(false); saveDraft();
}

// Cheque/Passbook preview
fileCheque.addEventListener('change', ()=>{
  const f=fileCheque.files && fileCheque.files[0];
  if(!f){ preCheque.src=''; preCheque.classList.add('hidden'); return; }
  const url=URL.createObjectURL(f);
  preCheque.src=url; preCheque.classList.remove('hidden');
});

// Statement (optional) — show file name and password only for PDF
fileStmt.addEventListener('change', ()=>{
  const f = fileStmt.files && fileStmt.files[0];
  if(!f){ stmtFileName.textContent=''; stmtFileName.classList.add('hidden'); stmtPwWrap.classList.add('hidden'); stmtPw.value=''; return; }
  stmtFileName.textContent = f.name;
  stmtFileName.classList.remove('hidden');
  const isPdf = f.type === 'application/pdf' || /\.pdf$/i.test(f.name);
  stmtPwWrap.classList.toggle('hidden', !isPdf); // show only if PDF
});

// Validation
function validate(show){
  const v={
    holder: String(holder.value||'').trim().length>=3,
    ifsc: isIFSC(ifsc.value),
    acc1: isAcc(acc1.value),
    acc2: isAcc(acc2.value) && acc2.value===acc1.value,
    cheque: fileCheque.files.length>0
    // NOTE: statement optional; password also optional even if PDF
  };
  if(show){
    setErr('gHolder', !v.holder);
    setErr('gIFSC',   !v.ifsc);
    setErr('gAcc1',   !v.acc1);
    setErr('gAcc2',   !v.acc2);
    setErr('gCheque', !v.cheque);
  }
  const ok = Object.values(v).every(Boolean);
  nextBtn.disabled = !ok;
  nextBtn.className = ok
    ? "px-8 py-3 rounded-full font-semibold text-white bg-[#0A2F33] hover:bg-[#062327] transition"
    : "px-8 py-3 rounded-full font-semibold text-white bg-gray-300 cursor-not-allowed transition";
  return ok;
}
['holder','ifsc','acc1','acc2','fileCheque','fileStmt','stmtPw'].forEach(id=>{
  const el=document.getElementById(id);
  el.addEventListener('input', ()=>validate(false));
  el.addEventListener('change',()=>validate(true));
});

// Draft (no file storage)
function saveDraft(){
  const rec={
    holder: holder.value.trim(),
    ifsc: ifsc.value.trim().toUpperCase(),
    acc: acc1.value.trim(),
    bank: bankName.value.trim(),
    branch: branch.value.trim(),
    stmtFile: (fileStmt.files[0]?.name)||'',
    stmtPw: stmtPw.value || '',
    ts: Date.now()
  };
  localStorage.setItem(DRAFT_KEY, JSON.stringify(rec));
}
function loadDraft(){
  try{
    const d=JSON.parse(localStorage.getItem(DRAFT_KEY)||'null'); if(!d) return;
    if(d.holder) holder.value=d.holder;
    if(d.ifsc)   ifsc.value=d.ifsc;
    if(d.acc)    { acc1.value=d.acc; acc2.value=d.acc; }
    if(d.bank)   bankName.value=d.bank;
    if(d.branch) branch.value=d.branch;
    if(d.stmtFile){
      stmtFileName.textContent=d.stmtFile;
      stmtFileName.classList.remove('hidden');
      // Can't restore actual file for security reasons
    }
    if(d.stmtPw){
      stmtPw.value=d.stmtPw;
      stmtPwWrap.classList.remove('hidden');
    }
  }catch{}
}

// Submit → stage Offer (server integration later)
document.getElementById('bform').addEventListener('submit', e=>e.preventDefault());
document.getElementById('nextBtn').addEventListener('click', e=>{
  e.preventDefault();
  if(!validate(true)) return;

  saveDraft();
  const app=getApp()||{};
  setApp({ ...app, stage:'Offer' }); // later: set from server response
  setLocked(true);
  window.location.href='offer.html';
});

// Back
document.getElementById('backBtn').addEventListener('click', e=>{
  e.preventDefault();
  if(history.length>1) history.back(); else location.href='apply.kyc.html';
});

// Init
(function(){
  const app=getApp()||{};
  if(app?.appId){ showAppId(app.appId); }

  const stage=(app?.stage)||'Personal';
  if(stage!=='Bank'){
    setLocked(true);
    setTimeout(()=>location.href=routeToStage(stage),300);
  } else {
    setLocked(false);
  }
  loadDraft();
  validate(false);
})();
</script>
</body>
</html>